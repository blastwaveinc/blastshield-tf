# Blastshield Terraform Provider

## Project Overview

This is a Terraform provider for managing Blastshield resources, generated from OpenAPI specifications. The provider supports multiple API versions and automatically selects the correct one at runtime.

## Architecture

### Multi-Version Support

The provider compiles code for every API version in `openapi-specs/` into a single binary. At startup, it detects the remote server's API version and selects the best matching compiled-in version.

**Version selection logic:**
- Fetches `GET {host}/openapi.json` to get the server's API version
- Selects the highest compiled-in version <= server version
- Falls back to the latest compiled-in version if the server is unreachable (e.g., `terraform validate`)

**Version detection happens in `main.go`** before `providerserver.Serve()`, because the Terraform framework calls `Resources()`/`DataSources()` before `Configure()`.

### Code Generation

Each OpenAPI spec in `openapi-specs/` (e.g., `1.13.0.json`) generates its own Go package (e.g., `internal/provider/v1_13_0/`).

**Run the generator:**
```bash
make generate
```

This loops over all specs, generates per-version packages, and creates the version imports file.

**Generator CLI:**
```bash
python3 generate.py --spec <path> --output-dir <path> --package <name>
```

**Generated files per version package** (e.g., `internal/provider/v1_13_0/`):

- `client.go` - Client interface that the provider's Client must implement
- `types.go` - Request/Response structs for all resources
- `schemas.go` - Terraform schema definitions
- `helpers.go` - Helper functions for type conversions
- `register.go` - Version registration via `init()` + `VersionProvider` type
- `*_resource.go` - Resource implementations (CRUD operations)
- `*_data_source.go` - Data source implementations (singular and plural)
- `test_helpers_test.go` - Test configuration and helper functions
- `resources_test.go` - Basic acceptance tests for all resources

**Other generated files:**

- `internal/provider/versionimports/imports.go` - Blank imports of all version packages (generated by `generate_imports.py`)

### Hand-written Files

- `internal/provider/client.go` - API client implementation with HTTP methods
- `internal/provider/provider.go` - Provider configuration and registration (delegates to VersionedProvider)
- `internal/provider/versions/registry.go` - Version registry with semver selection
- `main.go` - Entry point with API version detection

### Key Packages

- `versions` - Version registry. Each version package calls `versions.Register()` in its `init()`.
- `versionimports` - Blank imports to ensure all version packages are linked.
- `v1_13_0`, etc. - Per-version generated code with resources, data sources, schemas, and types.

## Generator Customizations

The generator has special handling for certain resources configured at the top of `generate.py`:

### RESOURCES_WITH_GROUPS
Resources with a separate `/resource/{id}/groups` endpoint for group membership:
- Node
- Endpoint

These get an additional `groups` attribute with `[{id, expires}]` structure.

### STORE_POST_RESPONSE
Resources where POST returns a different response that should be preserved:
- Node (returns invitation data with registration tokens)

The POST response is stored as base64-encoded JSON in an `invitation` field.

### POST_RESPONSE_ID_FIELD
Custom field name in POST response that contains the entity ID:
- Node uses `node_id` (from InvitationResponse)

## Automatic Nested Field Handling

The generator automatically handles nested object arrays from the OpenAPI spec:
- **Service.protocols**: Array of `{ip_protocol, ports}` objects
- **EgressPolicy.dns_names**: Array of `{name, recursive}` objects
- **Group.endpoints/users**: Array of `{id, expires}` objects

These are generated as `ListNestedAttribute` in Terraform schemas with proper type handling for both reading from API responses and writing to API requests.

## Build Commands

```bash
# Generate code from all OpenAPI specs
make generate

# Build the provider
go build ./...

# Run unit tests
go test ./...

# Run all acceptance tests (requires running API server)
make testacc

# Run acceptance tests for a specific resource
make testacc-Node

# Run acceptance tests for a specific version
make testacc-version-v1_13_0

# Run acceptance tests for a specific resource in a specific version
make testacc-version-v1_13_0-resource-Node
```

## Adding a New API Version

### Option 1: Fetch from Remote Server

```bash
# Set your API credentials
export BLASTSHIELD_HOST=https://your-api-server.com
export BLASTSHIELD_TOKEN=your-token

# Fetch the OpenAPI spec (automatically saved to openapi-specs/{version}.json)
make fetch-openapi

# Generate code for all versions including the new one
make generate

# Build
go build ./...
```

### Option 2: Manual Placement

1. Place the new OpenAPI spec in `openapi-specs/` (e.g., `1.14.0.json`)
2. Run `make generate` — this creates `internal/provider/v1_14_0/` with all code and tests
3. `go build ./...` — the new version is compiled into the binary
4. At runtime, the provider will automatically select it when appropriate
5. Tests are generated automatically but can be customized for version-specific features

## Testing Strategy

### Version-Specific Tests

Each API version package includes auto-generated acceptance tests in `resources_test.go`. These tests:
- Are specific to that API version's schema and features
- Run against a live API server
- Use the `TestTag` constant to mark test entities for cleanup
- Include basic CRUD operations and import testing

### Running Tests

```bash
# Run all tests
make testacc

# Run tests for a specific version only
make testacc-version-v1_13_0

# Run tests for a specific resource across all versions
make testacc-Node

# Run tests for a specific resource in a specific version
make testacc-version-v1_13_0-resource-Node
```

### Test Configuration

Tests require:
- `BLASTSHIELD_HOST` environment variable (defaults to `http://localhost:4999`)
- `BLASTSHIELD_TOKEN` environment variable (defaults to `dev`)
- `TF_ACC=1` environment variable to enable acceptance tests

### Cleaning Up Test Resources

After test failures, dangling resources may remain in the API. Clean them up with:

```bash
# First, preview what will be deleted (dry run)
make cleanup-test-entities-dryrun

# Then, delete the test entities (with confirmation prompt)
make cleanup-test-entities
```

The dry run will show:
- All test entities found (ID and name)
- Organized by resource type
- No deletions performed

The cleanup will:
- Prompt for confirmation before deleting
- Query all resource types for entities tagged with `blastshield_tf_testing_entity`
- Delete each found entity
- Work across all resource types (nodes, endpoints, groups, services, policies, etc.)
- Show progress as it deletes

**Requirements**: `curl` and `jq` must be installed

**Note**: Both commands use the same `BLASTSHIELD_HOST` and `BLASTSHIELD_TOKEN` environment variables as the tests.

### Customizing Generated Tests

The generated tests provide basic coverage. For version-specific features:
1. Tests are generated from templates in `codegen-templates/`
2. Add version-specific test cases manually in the version package
3. Generated tests include tags support automatically (when available in the API version)

## Key Design Decisions

1. **GET after POST**: All resources perform a GET request after POST because the API's POST endpoints don't return the full entity.

2. **Interface-based Client**: The generated code uses a `Client` interface (not a concrete type) to avoid import cycles between version packages and the `provider` package.

3. **Raw methods for groups**: `GetGroupsRaw` and `UpdateGroupsRaw` use `interface{}` parameters to handle the `[]GroupMembership` type without import cycles.

4. **CreateRaw for POST responses**: Returns raw `[]byte` so resources can parse and store the full response (needed for Node's invitation data).

5. **Version detection in main.go**: Performed before `providerserver.Serve()` because the framework calls `Resources()`/`DataSources()` before `Configure()`. Different API versions may have different resources/schemas.

6. **Highest version <= server**: The provider selects the highest compiled-in version that doesn't exceed the server's version, ensuring forward compatibility within a minor version.

## Resources

- `blastshield_node`
- `blastshield_endpoint`
- `blastshield_group`
- `blastshield_service`
- `blastshield_policy`
- `blastshield_egress_policy`
- `blastshield_proxy`
- `blastshield_event_log_rule`

## Data Sources

Each resource has both singular and plural data sources:
- `blastshield_node` / `blastshield_nodes`
- `blastshield_endpoint` / `blastshield_endpoints`
- etc.
